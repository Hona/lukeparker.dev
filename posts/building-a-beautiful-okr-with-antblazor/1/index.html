<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="Luke Parker"><meta name=description content="Boilerplate GitHub  Create a repository called OKR, and initialize it with only a README.md file Open GitHub Desktop, and clone the repository to your machine  Folder Structure The physical folder structure will be:
OKR │ README.md │ Docker Related files | .sln │ ... | └───src │ └─── ... (Projects e.g. 'OKR.Web') │ .csproj │ Dockerfile │ ... Setup Solution + Projects  Open the folder in the file explorer, and Shift + Right Click -> Open PowerShell window here."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building a Beautiful OKR with AntBlazor - Part 1"><meta name=twitter:description content="Boilerplate GitHub  Create a repository called OKR, and initialize it with only a README.md file Open GitHub Desktop, and clone the repository to your machine  Folder Structure The physical folder structure will be:
OKR │ README.md │ Docker Related files | .sln │ ... | └───src │ └─── ... (Projects e.g. 'OKR.Web') │ .csproj │ Dockerfile │ ... Setup Solution + Projects  Open the folder in the file explorer, and Shift + Right Click -> Open PowerShell window here."><meta property="og:title" content="Building a Beautiful OKR with AntBlazor - Part 1"><meta property="og:description" content="Boilerplate GitHub  Create a repository called OKR, and initialize it with only a README.md file Open GitHub Desktop, and clone the repository to your machine  Folder Structure The physical folder structure will be:
OKR │ README.md │ Docker Related files | .sln │ ... | └───src │ └─── ... (Projects e.g. 'OKR.Web') │ .csproj │ Dockerfile │ ... Setup Solution + Projects  Open the folder in the file explorer, and Shift + Right Click -> Open PowerShell window here."><meta property="og:type" content="article"><meta property="og:url" content="https://www.lukeparker.dev/posts/building-a-beautiful-okr-with-antblazor/1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-02T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-02T00:00:00+00:00"><meta property="og:see_also" content="https://www.lukeparker.dev/posts/building-a-beautiful-okr-with-antblazor/2/"><meta property="og:see_also" content="https://www.lukeparker.dev/posts/building-a-beautiful-okr-with-antblazor/0/"><title>Building a Beautiful OKR with AntBlazor - Part 1 · lukeparker.dev</title><link rel=canonical href=https://www.lukeparker.dev/posts/building-a-beautiful-okr-with-antblazor/1/><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fork-awesome/1.1.7/css/fork-awesome.min.css integrity="sha512-9QjPqX/aCNwEQDyMqqMluNOSsHxTwOJNO3d4m5aUeNbyOPm8RcBA5hCUhvGmKFtSmQYGajqPopGtD60FWiWUwg==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w==" crossorigin=anonymous><link rel=stylesheet href=/css/coder.min.f01c647a0d25b40da992a37c3376291185eed8a50ced8c26cc2c0bcfe38c97df.css integrity="sha256-8Bxkeg0ltA2pkqN8M3YpEYXu2KUM7YwmzCwLz+OMl98=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><script src=https://cdnjs.cloudflare.com/ajax/libs/twemoji/12.0.4/2/twemoji.min.js integrity="sha512-panBjUGuKarjg0qxHggQULmRf9jB/YVCy238hmzBWUuLeOuwMSuJgJcUv3T+rwXUBZ9zeUvc49ZcCRH+EO0H8g==" crossorigin=anonymous></script><meta name=generator content="Hugo 0.81.0"></head><body class=colorscheme-auto onload=twemoji.parse(document.body)><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>lukeparker.dev</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact me</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Building a Beautiful OKR with AntBlazor - Part 1</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2021-02-02T00:00:00Z>February 2, 2021</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>5-minute read</span></div><div class=authors><i class="fa fa-user" aria-hidden=true></i><a href=/authors/luke-parker/>Luke Parker</a></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i><a href=/categories/development/>Development</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i><a href=/tags/blazor/>Blazor</a>
<span class=separator>•</span>
<a href=/tags/antdesign/>AntDesign</a>
<span class=separator>•</span>
<a href=/tags/antblazor/>AntBlazor</a>
<span class=separator>•</span>
<a href=/tags/c/>C#</a>
<span class=separator>•</span>
<a href=/tags/okr/>OKR</a></div></div></header><div><h2 id=boilerplate>Boilerplate</h2><h3 id=github>GitHub</h3><ol><li>Create a repository called <code>OKR</code>, and initialize it with only a README.md file</li><li>Open GitHub Desktop, and clone the repository to your machine</li></ol><h3 id=folder-structure>Folder Structure</h3><p>The physical folder structure will be:</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>OKR
│   README.md
│   Docker Related files
|   .sln    
│   ...
|
└───src
    │   
    └─── ... (Projects e.g. &#39;OKR.Web&#39;)
        │   .csproj
        │   Dockerfile
        │   ...
</code></pre></div><h3 id=setup-solution--projects>Setup Solution + Projects</h3><ol><li>Open the folder in the file explorer, and <code>Shift + Right Click -> Open PowerShell window here</code>. Type <code>dotnet new gitignore</code> to generate a .gitignore file. Feel free to make this file the first git commit</li><li>Create a new empty solution (<code>Blank Solution</code> in VS, <code>Empty Solution</code> in Rider) and call it <code>OKR</code></li><li>Create a solution folder <code>src/</code> - this is not a physical folder, its part of the solution</li><li>Create a solution folder <code>Solution Items</code>, and add the existing items, README.md and .gitignore. In the future the docker files will be added here too</li><li>Add 4 projects to the <code>src/</code> solution folder, and the <code>src/</code> physical folder path - these are following the DDD principals<ul><li><code>OKR.Web</code> <strong>Blazor Server</strong> - here is where the Blazor frontend code will be, separate from business logic + data access layers</li><li><code>OKR.Application</code> <strong>Class Library</strong> - here is the business logic layer with references to repository interfaces from the <code>OKR.Core</code> layer to abstract data access away from business logic</li><li><code>OKR.Core</code> <strong>Class Library</strong> - here is the core domain models, and repository interfaces</li><li><code>OKR.Infrastructure</code> <strong>Class Library</strong> - here are the implementations of repository interfaces using Marten</li></ul></li></ol><h2 id=devops>DevOps</h2><p>Its always nice to have DevOps from day 0 of your project, so lets add it!</p><h3 id=github-ci>GitHub CI</h3><p>To setup the dotnet build + test action, go to the <code>GitHub Repository -> Actions -> .NET -> Set up this workflow</code>. The template file works without any changes, because our .sln is in the root directory - so click <code>Start commit -> Commit directly to the main branch</code>, add a commit message like <code>Add dotnet CI</code>, and finally <code>Commit new file</code></p><h3 id=docker>Docker</h3><p>First we need a Dockerfile to create an image for the Blazor site. Visual Studio automatically generates Dockerfiles - right click the OKR.Web project, <code>Add -> Docker Support -> Linux -> Ok</code>. That&rsquo;s all it takes! When projects get dependencies make sure to run this again (like when you reference projects)</p><h3 id=docker-compose>Docker Compose</h3><p>Now we need to orchestrate the config for the Blazor site, and include the postgres database all in one.</p><p>Create a blank file called <code>docker-compose.yml</code> and add it to the <code>Solution Items/</code> folder in the .sln.</p><p>Fill it out with the following:</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=font-weight:700>version</span>: <span style=color:#0ff;font-weight:700>&#34;3.8&#34;</span>
<span style=font-weight:700>services</span>:
  <span style=font-weight:700>frontend</span>:
    <span style=font-weight:700>build</span>:
      <span style=font-weight:700>dockerfile</span>: src/OKR.Web/Dockerfile
      <span style=font-weight:700>context</span>: .
    <span style=font-weight:700>image</span>: okr-frontend
    <span style=font-weight:700>container_name</span>: OkrFrontend
    <span style=font-weight:700>restart</span>: unless-stopped
    <span style=font-weight:700>environment</span>:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_ConnectionStrings__Marten=User ID = okr;Password=o32342134k4r%Y#%Y345yRasdf;Server=postgres;Port=5432;Database=okr_db;Integrated Security=true;Pooling=true
    <span style=font-weight:700>volumes</span>:
      - ./config/appsettings.json:/app/appsettings.json
    <span style=font-weight:700>ports</span>:
    - <span style=color:#0ff;font-weight:700>&#34;9595:80&#34;</span>
  <span style=font-weight:700>postgres</span>:
    <span style=font-weight:700>image</span>: postgres
    <span style=font-weight:700>container_name</span>: OkrPostgres
    <span style=font-weight:700>environment</span>:
      - POSTGRES_USER=okr
      - POSTGRES_PASSWORD=o32342134k4r%Y#%Y345yRasdf
      - POSTGRES_DB=okr_db
    <span style=font-weight:700>volumes</span>:
      - ./data:/var/lib/postgresql/data
</code></pre></div><p>Note the two services, the frontend and database. The secrets for the database are hardcoded - this is fine since the database is not exposed to the internet, but for added security feel free to make this in a config file.</p><p>The frontend is exposed to the VPS&rsquo;s port 9595, proxying the request to the containers port 80.</p><p>To start the whole system you can run <code>docker-compose up -d --build</code> (<code>-d</code> detached mode, <code>--build</code> builds the Dockerfile)</p><p>Ensure on your VPS you have installed Git, Docker and Docker Compose.</p><h3 id=domain--reverse-proxy>Domain + Reverse Proxy</h3><h4 id=cloudflare>Cloudflare</h4><p>This site will run on a subdomain <code>okr.lukeparker.dev</code>, so I will walk through that. (If you want to point it to a root domain, like <code>lukeparker.dev</code> use an <code>A</code> record pointing to your VPS IP address instead)</p><p>Since I have a record for <code>lukeparker.dev</code> to point to my VPS, I just need to add a CNAME record to proxy <code>okr.lukeparker.dev</code> to the same IP as <code>lukeparker.dev</code>.</p><p>Open up the Cloudflare dashboard and goto the site (in my case <code>lukeparker.dev</code>), the click the DNS page. Click <code>Add record</code>:</p><ul><li>Change Type to: <code>CNAME</code></li><li>Change Name to: <code>okr</code></li><li>Change Content to: <code>@</code> (<code>@</code> will resolve to the base domain - <code>lukeparker.dev</code>)</li></ul><p>Then click save.</p><p>This may take a minute or two to update in Cloudflare&rsquo;s network, but it is pretty fast.</p><h4 id=nginx-on-vps>NGINX on VPS</h4><p>Ok so now we have requests incoming, we need to proxy <code>okr.lukeparker.dev -> localhost:9595</code></p><p>I have a global NGINX docker-compose repository you can reference that I use for my VPS and sites: <a href=https://github.com/Hona/azetio-nginx>azetio-nginx</a></p><p>Before we begin you need to install the Cloudflare Origin Certificate on your server, so follow <a href=https://support.cloudflare.com/hc/en-us/articles/115000479507-Managing-Cloudflare-Origin-CA-certificates>this guide</a> - make sure to note where and what the certificates are called. If you are running your global NGINX server in Docker, make sure to mount the certificate files. <a href=https://blog.cloudflare.com/cloudflare-ca-encryption-origin/>Read more here</a></p><p>If you used my azetio-nginx, then add a new file in nginx/sites-enabled/ called <code>lukeparker.dev.okr.conf</code> and fill it out with the following (renamed to match your domain):</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#fff;font-weight:700>server</span> {
    <span style=color:#fff;font-weight:700>listen</span> <span style=color:#ff0;font-weight:700>80</span>;
    <span style=color:#fff;font-weight:700>server_name</span> <span style=color:#0ff;font-weight:700>okr.lukeparker.dev</span> <span style=color:#0ff;font-weight:700>www.okr.lukeparker.dev</span>;

    <span style=color:#fff;font-weight:700>return</span> <span style=color:#ff0;font-weight:700>301</span> <span style=color:#0ff;font-weight:700>https://okr.lukeparker.dev</span>$request_uri;
}

<span style=color:#fff;font-weight:700>server</span> {
    <span style=color:#fff;font-weight:700>listen</span> <span style=color:#ff0;font-weight:700>443</span> <span style=color:#0ff;font-weight:700>ssl</span>;
    <span style=color:#fff;font-weight:700>server_name</span> <span style=color:#0ff;font-weight:700>okr.lukeparker.dev</span> <span style=color:#0ff;font-weight:700>www.okr.lukeparker.dev</span>;

    <span style=color:#fff;font-weight:700>ssl_certificate</span> <span style=color:#0ff;font-weight:700>/etc/ssl/certs/lukeparker.pem</span>;
    <span style=color:#fff;font-weight:700>ssl_certificate_key</span> <span style=color:#0ff;font-weight:700>/etc/ssl/private/lukeparker.pem</span>;
    <span style=color:#fff;font-weight:700>ssl_client_certificate</span> <span style=color:#0ff;font-weight:700>/etc/ssl/certs/origin-pull-ca.pem</span>;
    <span style=color:#fff;font-weight:700>ssl_verify_client</span> on;

    <span style=color:#fff;font-weight:700>ssl_session_cache</span> builtin:<span style=color:#ff0;font-weight:700>1000</span> <span style=color:#0ff;font-weight:700>shared:SSL:10m</span>;
    <span style=color:#fff;font-weight:700>ssl_protocols</span> <span style=color:#0ff;font-weight:700>TLSv1</span> <span style=color:#0ff;font-weight:700>TLSv1.1</span> <span style=color:#0ff;font-weight:700>TLSv1.2</span>;
    <span style=color:#fff;font-weight:700>ssl_ciphers</span> <span style=color:#0ff;font-weight:700>HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4</span>;
    <span style=color:#fff;font-weight:700>ssl_prefer_server_ciphers</span> on;

    <span style=color:#fff;font-weight:700>location</span> <span style=color:#0ff;font-weight:700>/</span> {
        <span style=color:#fff;font-weight:700>proxy_pass</span> <span style=color:#0ff;font-weight:700>http://localhost:9595</span>;
        <span style=color:#fff;font-weight:700>proxy_http_version</span> <span style=color:#ff0;font-weight:700>1</span><span style=color:#0ff;font-weight:700>.1</span>;
        <span style=color:#fff;font-weight:700>proxy_set_header</span> <span style=color:#0ff;font-weight:700>Upgrade</span> $http_upgrade;
        <span style=color:#fff;font-weight:700>proxy_set_header</span> <span style=color:#0ff;font-weight:700>Connection</span> <span style=color:#0ff;font-weight:700>keep-alive</span>;
        <span style=color:#fff;font-weight:700>proxy_set_header</span> <span style=color:#0ff;font-weight:700>Host</span> $host;
        <span style=color:#fff;font-weight:700>proxy_cache_bypass</span> $http_upgrade;
        <span style=color:#fff;font-weight:700>proxy_set_header</span> <span style=color:#0ff;font-weight:700>X-Forwarded-For</span> $proxy_add_x_forwarded_for;
        <span style=color:#fff;font-weight:700>proxy_set_header</span> <span style=color:#0ff;font-weight:700>X-Forwarded-Proto</span> $scheme;
        <span style=color:#fff;font-weight:700>proxy_read_timeout</span> <span style=color:#ff0;font-weight:700>3600</span>;
    }
}
</code></pre></div><p>This configuration will automatically redirect http -> https, and proxy requests to the 9595 port, passing forwarded headers.</p><p>Note that if you aren&rsquo;t using my nginx config: add this to the <code>http { ... }</code> clause:</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#fff;font-weight:700>map</span> $http_upgrade $connection_upgrade {
        <span style=color:#fff;font-weight:700>default</span> <span style=color:#0ff;font-weight:700>Upgrade</span>;
        <span style=color:#fff;font-weight:700>&#39;&#39;</span> <span style=color:#0ff;font-weight:700>close</span>;
    }
</code></pre></div><p>Make sure to read <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-5.0">Host ASP.NET Core on Linux with Nginx</a> to understand the config.</p><p>With all this setup, make sure to restart the azetio-nginx config with <code>docker-compose up -d --force-recreate</code></p><p>On the VPS, we need to first clone the git repository, so run <code>git clone git@github.com:Hona/OKR</code> (Replace with your username + repository)</p><p>Navigate to the repo: <code>cd OKR</code></p><p>Make sure to create the config directory and an empty appsettings.json file:</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>mkdir config
<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;{ }&#34;</span> &gt; <span style=color:#0ff;font-weight:700>&#34;config/appsettings.json&#34;</span>
</code></pre></div><p>Then start the OKR project with
<code>docker-compose up -d --build</code></p><p>If all goes well, navigate to the domain you setup, and you should see the default Blazor page, if you do, everything is setup perfectly!</p><hr><p>In the next post, I will plan and setup the core models, repository interfaces and mock repositories.</p><p><a href=https://lukeparker.dev/posts/building-a-beautiful-okr-with-antblazor/0>← Part 0</a> | <a href=https://lukeparker.dev/posts/building-a-beautiful-okr-with-antblazor/2>Part 2 →</a></p></div><footer><section class=see-also><h3>See also in OKR</h3><nav><ul><li><a href=/posts/building-a-beautiful-okr-with-antblazor/2/>Building a Beautiful OKR with AntBlazor - Part 2</a></li><li><a href=/posts/building-a-beautiful-okr-with-antblazor/0/>Building a Beautiful OKR with AntBlazor - Part 0</a></li></ul></nav></section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//lukeparker-dev.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></section></div><footer class=footer><section class=container><p>Software Architect at <a href=https://ssw.com.au>ssw.com.au</a> and <a href=https://tv.ssw.com.au>SSW TV tv.ssw.com</a></p>©
2020 -
2021
Luke Parker
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/dark-mode.min.aee9c8a464eb7b3534c7110f7c5e169e7039e2fd92710e0626d451d6725af137.js></script></body></html>